<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>24시간 실시간 BTC 프로그램 + 고래 + 롱숏 알람 방송</title>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
  body,html{margin:0;padding:0;height:100%;background:#000;overflow:hidden;font-family:'Malgun Gothic',sans-serif;color:#0f0;}
  #chart{width:100vw;height:100vh;}
  #ticker{position:fixed;bottom:10px;left:0;width:100%;font-size:28px;background:rgba(0,0,0,0.7);padding:10px 0;text-align:center;white-space:nowrap;overflow:hidden;}
  #bigStatus{position:fixed;top:15%;left:50%;transform:translateX(-50%);font-size:110px;font-weight:900;letter-spacing:8px;
    text-shadow:0 0 30px currentColor;z-index:999;opacity:0.9;pointer-events:none;animation:glow 2s infinite;}
  @keyframes glow{0%,100%{text-shadow:0 0 30px currentColor;}50%{text-shadow:0 0 80px currentColor;}}
</style>
</head>
<body>
<div id="chart"></div>
<div id="ticker">BTCUSDT 실시간 대기중...</div>
<div id="bigStatus">지금은 대기중</div>

<!-- 음원 (외부 무료 링크 - 저작권 안전) -->
<audio id="buy" src="https://freesound.org/data/previews/612/612647_5674468-lq.mp3"></audio>
<audio id="sell" src="https://freesound.org/data/previews/276/276509_5123858-lq.mp3"></audio>
<audio id="explosion" src="https://freesound.org/data/previews/320/320819_5270808-lq.mp3"></audio>

<script>
// 차트 초기화
const chart = LightweightCharts.createChart(document.getElementById('chart'), {
  width: innerWidth, height: innerHeight,
  layout: { background: { color: '#000' }, textColor: '#0f0' },
  grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
  timeScale: { timeVisible: true }
});
const candle = chart.addCandlestickSeries({ upColor: '#00ff88', downColor: '#ff0066', wickUpColor: '#00ff88', wickDownColor: '#ff0066' });
const ema20 = chart.addLineSeries({ color: '#ffff00', lineWidth: 2 });
const ema60 = chart.addLineSeries({ color: '#00ffff', lineWidth: 2 });

let data = [], prevTrend = null, currentPosition = 'NONE';
let buyVol5s = 0, sellVol5s = 0, lastReset = Date.now();

const bigStatus = document.getElementById('bigStatus');
function setBigStatus(text, color) {
  bigStatus.textContent = text;
  bigStatus.style.color = color;
}

// Bybit WebSocket 연결
const ws = new WebSocket('wss://stream.bybit.com/v5/public/linear');
ws.onopen = () => ws.send(JSON.stringify({
  "op": "subscribe",
  "args": ["klineV2.1m.BTCUSDT", "publicTrade.BTCUSDT", "liquidation.BTCUSDT", "orderbook.50.BTCUSDT"]
}));

ws.onmessage = e => {
  const m = JSON.parse(e.data);

  // 캔들 + EMA + SuperTrend 진입 판단
  if (m.topic?.includes('kline')) {
    const k = m.data[0];
    const bar = { time: k.start, open: +k.open, high: +k.high, low: +k.low, close: +k.close };
    data.push(bar); if (data.length > 300) data.shift();
    candle.update(bar);

    if (data.length > 60) {
      let s20 = 0, s60 = 0;
      for (let i = data.length - 20; i < data.length; i++) s20 += data[i].close;
      for (let i = data.length - 60; i < data.length; i++) s60 += data[i].close;
      ema20.update({ time: bar.time, value: s20 / 20 });
      ema60.update({ time: bar.time, value: s60 / 60 });
    }

    if (data.length > 20) {
      const atr = data.slice(-14).reduce((a, c, i, arr) => a + Math.max(c.high - c.low, Math.abs(c.high - (arr[i-1]?.close || 0)), Math.abs(c.low - (arr[i-1]?.close || 0))) / 14, 0);
      const mid = (data.at(-1).high + data.at(-1).low) / 2;
      const up = mid + 3 * atr;
      const trend = data.at(-1).close > up ? 'UP' : 'DOWN';

      if (trend === 'UP' && prevTrend === 'DOWN') {
        currentPosition = 'LONG';
        setBigStatus('지금 롱 진입', '#00ff88');
        confetti({ particleCount: 400, spread: 100 });
        document.getElementById('buy').play();
      }
      if (trend === 'DOWN' && prevTrend === 'UP') {
        currentPosition = 'SHORT';
        setBigStatus('지금 숏 진입', '#ff0066');
        confetti({ particleCount: 400, spread: 100 });
        document.getElementById('sell').play();
      }
      prevTrend = trend;
    }
  }

  // 청산 티커
  if (m.topic?.includes('liquidation')) {
    const l = m.data[0];
    document.getElementById('ticker').innerHTML += `　${l.side === 'Buy' ? '롱청산' : '숏청산'} $${(l.size * l.price).toFixed(0)} 폭탄　`;
  }

  // 프로그램 + 고래 탐지 (단일 체결 + 델타)
  if (m.topic?.includes('publicTrade')) {
    const t = m.data[0];
    const value = parseFloat(t.size) * parseFloat(t.price);
    if (t.side === 'Buy') buyVol5s += value; else sellVol5s += value;

    if (value >= 1_500_000) {
      const div = document.createElement('div');
      div.textContent = `프로그램 ${t.side === 'Buy' ? '매수' : '매도'} $${(value / 1e6).toFixed(1)}M 폭탄!!`;
      div.style.cssText = `position:fixed;top:30%;left:50%;transform:translateX(-50%);font-size:80px;color:${t.side === 'Buy' ? '#00ff88' : '#ff0066'};font-weight:900;z-index:999;`;
      document.body.appendChild(div);
      confetti({ particleCount: 500, spread: 120 });
      document.getElementById('explosion').play();
      setTimeout(() => div.remove(), 6000);
    }
  }

  // 5초 델타 폭발
  if (Date.now() - lastReset > 5000) {
    const delta = buyVol5s - sellVol5s;
    if (Math.abs(delta) >= 2_000_000) {
      const div = document.createElement('div');
      div.textContent = `델타 폭발 ${delta > 0 ? '매수' : '매도'} $${(Math.abs(delta) / 1e6).toFixed(1)}M`;
      div.style.cssText = `position:fixed;top:25%;left:50%;transform:translateX(-50%);font-size:80px;color:${delta > 0 ? '#00ff88' : '#ff0066'};z-index:999;`;
      document.body.appendChild(div);
      confetti({ particleCount: 400, spread: 100 });
      document.getElementById('explosion').play();
      setTimeout(() => div.remove(), 6000);
    }
    buyVol5s = sellVol5s = 0;
    lastReset = Date.now();
  }

  // 실시간 상태 업데이트
  setBigStatus(
    currentPosition === 'LONG' ? '지금 롱 진입' : currentPosition === 'SHORT' ? '지금 숏 진입' : '지금은 대기중',
    currentPosition === 'LONG' ? '#00ff88' : currentPosition === 'SHORT' ? '#ff0066' : '#888'
  );
};

// 리사이즈
addEventListener('resize', () => chart.resize(innerWidth, innerHeight));

// 초기 상태
setBigStatus('지금은 대기중', '#888');
</script>
</body>
</html>
